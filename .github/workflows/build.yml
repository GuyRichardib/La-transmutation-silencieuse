name: Build Book

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Install TeX Live + EB Garamond (robuste)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-xetex \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            fonts-ebgaramond \
            poppler-utils
          sudo fc-cache -f -v

      - name: Preflight - verify @include targets
        run: python3 scripts/verify_includes.py .

      - name: Count words
        run: python3 scripts/wordcount.py

      - name: Normalize Unicode (NFC)
        run: python3 scripts/normalize_unicode.py

      - name: Build all formats
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh

      - name: Verify PDF page size (6x9 in = 432x648 pts)
        run: |
          echo "VÃ©rification des dimensions du PDF..."
          pdfinfo dist/book.pdf | grep "Page size"
          pdfinfo dist/book.pdf | grep -E "Page size:\s*432 x 648" || (echo "ERREUR: Le PDF n'est pas au format 6x9 KDP." && exit 1)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: book-artifacts
          path: dist/
