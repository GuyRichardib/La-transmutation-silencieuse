name: Build Book

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      - name: Install TeX Live packages and custom fonts
        run: |
          # 1. Installer les paquets TeX Live de base (votre code original)
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            fonts-lmodern \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            latexmk \
            texlive-xetex

          # 2. Mettre à jour la base de données de TeX Live (correction de l'erreur lmodern.sty)
          echo "Updating TeX Live file database..."
          sudo texhash

          # 3. Installer manuellement la police EB Garamond (correction de l'erreur font not found)
          echo "Installing EB Garamond font..."
          FONT_URL="https://raw.githubusercontent.com/google/fonts/main/ofl/ebgaramond/EBGaramond-Regular.ttf"
          FONT_PATH="/usr/local/share/fonts/truetype/ebgaramond/EBGaramond-Regular.ttf"
          sudo mkdir -p "$(dirname "$FONT_PATH")"
          if curl --fail --head --silent "$FONT_URL" > /dev/null; then
            sudo wget -O "$FONT_PATH" "$FONT_URL"
          else
            echo "Unable to reach $FONT_URL" >&2
            exit 1
          fi

          # 4. Mettre à jour le cache des polices du système pour que XeLaTeX la trouve
          echo "Updating system font cache..."
          sudo fc-cache -f -v

      - name: Count words
        run: python3 scripts/wordcount.py

      - name: Build EPUB/PDF/DOCX
        run: bash scripts/build.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: book-build
          path: dist/*
